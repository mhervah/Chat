Index: target/chat/resources/js/profile.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.BaseRevisionTextPatchEP
<+>/**\n * Created by mher.vahramyan on 11/2/2018.\n */\nfunction getCookie(name) {\n    var nameEQ = name + \"=\";\n    var ca = document.cookie.split(';');\n    for (var i = 0; i < ca.length; i++) {\n        var c = ca[i];\n        while (c.charAt(0) == ' ') c = c.substring(1, c.length);\n        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);\n    }\n    return null;\n}\nlet chats = new Map();\nlet username = getCurrentUser();\n$(document).ready(function () {\n\n\n    getUsers();\n\n});\nfunction getCurrentUser() {\n    let username;\n    var xhttp = new XMLHttpRequest();\n    xhttp.onreadystatechange = function () {\n        if (this.readyState == 4 && this.status == 200) {\n\n            let data = JSON.parse(this.responseText);\n            document.getElementById(\"username\").innerText = data;\n            username = data;\n        }\n    };\n    xhttp.open(\"get\", \"/login\", false);\n    xhttp.send();\n    return username;\n\n}\nfunction getUsers() {\n    var xhttp = new XMLHttpRequest();\n    xhttp.onreadystatechange = function () {\n        if (this.readyState == 4 && this.status == 200) {\n            var data = JSON.parse(this.responseText);\n            renderUsers(data);\n        }\n    };\n    xhttp.open(\"get\", \"allusers\", true);\n    xhttp.send();\n}\n\nfunction renderUsers(data) {\n    var list = document.getElementById(\"usersList\");\n    for (let key in data) {\n        var li = document.createElement(\"li\");\n        li.setAttribute(\"id\", key);\n        li.innerText = key;\n        let chatopen = false;\n        li.onclick = function (e) {\n\n\n            let username2 = e.toElement.id;\n            let interval = setInterval(function () {\n                getMessages(username2);\n            }, 500);\n            if (!chatopen) {\n\n                let div = document.createElement(\"div\");\n                div.setAttribute(\"id\", \"chat\" + username2);\n                let p = document.createElement(\"p\");\n                p.innerText = username2;\n                p.setAttribute(\"class\", \"chatUsername\");\n                let close = document.createElement(\"span\");\n                close.innerText = 'x';\n                close.setAttribute(\"class\", \"closeButton\");\n                close.setAttribute(\"id\", \"close\" + username2);\n                close.onclick = function (e) {\n                    closeChat(username2);\n                    chatopen = false;\n                    clearInterval(interval);\n                };\n\n                div.appendChild(p);\n                div.appendChild(close);\n                div.setAttribute(\"class\", \"chat\");\n                let messageBox = document.createElement(\"div\");\n                messageBox.setAttribute(\"id\", \"box\" + username2);\n                messageBox.setAttribute(\"class\", \"messageBox\");\n                div.appendChild(messageBox);\n                let input = document.createElement(\"input\");\n                input.setAttribute(\"id\", \"input\" + username2);\n                input.setAttribute(\"type\", \"text\");\n                input.setAttribute(\"class\", \"messageInput\");\n                div.appendChild(input);\n                let button = document.createElement(\"input\");\n                button.setAttribute(\"id\", \"button\" + username2);\n                button.setAttribute(\"type\", \"button\");\n                button.setAttribute(\"value\", \"Send\");\n                button.setAttribute(\"class\", \"messageButton\");\n                button.onclick = function (e) {\n                    let text = document.getElementById(\"input\" + username2).value;\n                    if (text !== \"\") {\n                        sendMessage(username2, text);\n                    }\n\n                };\n                div.appendChild(button);\n\n                document.getElementById(\"chats\").appendChild(div);\n\n\n                if(chats.get(username2))\n                    renderMessages(chats.get(username2),username2);\n                chatopen = true;\n            }\n        };\n        list.appendChild(li);\n    }\n}\nfunction closeChat(username) {\n    let chat = document.getElementById(\"chat\" + username);\n    chat.parentNode.removeChild(chat);\n\n}\nfunction sendMessage(reciever, text) {\n    let box = document.getElementById(\"box\" + reciever);\n    let input = document.getElementById(\"input\" + reciever);\n    var xhttp = new XMLHttpRequest();\n    xhttp.onreadystatechange = function () {\n        if (this.readyState == 4 && this.status == 200) {\n            getMessages(reciever);\n            input.value = \"\";\n        }\n    };\n    let messageInfo = {\n        \"reciever\": reciever,\n        \"text\": text,\n        \"date\": Date.now()\n    };\n    xhttp.open(\"post\", \"/messages\", true);\n    xhttp.send(JSON.stringify(messageInfo));\n\n}\nfunction getMessages(user2) {\n    let chat = chats.get(user2);\n\n    let lastMessageDate = chat && chat.length > 0 ? chat[chat.length - 1][\"date\"] :  0;\n    lastMessageDate = new Date(lastMessageDate);\n    //console.log(typeof lastMessageDate);\n    var xhttp = new XMLHttpRequest();\n    xhttp.onreadystatechange = function () {\n        if (this.readyState == 4 && this.status == 200) {\n            let data = JSON.parse(this.responseText);\n            renderMessages(data, user2);\n\n\n            if (chats.has(user2)) {\n                chats.set(user2, chats.get(user2).concat(data[\"new\"]));\n            } else {\n                chats.set(user2, data[\"new\"]);\n            }\n            lastMessageDate = chat && chat.length > 0 ? chat[chat.length - 1][\"date\"] :  0;\n            lastMessageDate = new Date(lastMessageDate);\n        }\n    };\n    xhttp.open(\"get\", \"/messages?user2=\" + user2 + \"&date=\" + (lastMessageDate ? lastMessageDate.getTime() : 0), false);\n    xhttp.send();\n\n}\nfunction renderMessages(messages, user2) {\n    var box = document.getElementById(\"box\" + user2);\n    if (box) {\n        if(messages[\"deleted\"]){\n            for (let i = 0; i < messages[\"deleted\"].length; i++) {\n                let chat = chats.get(user2);\n                for (let index in chat)\n                    if (messages[\"deleted\"][i][\"id\"] === chat[index][\"id\"]) {\n                        chat.splice(index, 1);\n                    }\n            }\n        }\n        if(messages[\"edited\"]) {\n            for (let i = 0; i < messages[\"edited\"].length; i++) {\n                if (chats.get(user2)) {\n                    for (let message of chats.get(user2)) {\n                        if (messages[\"edited\"][i][\"id\"] === message[\"id\"]) {\n                            if (messages[\"edited\"][i][\"text\"] !== message[\"text\"]) {\n                                let editedMessageText = document.getElementById(message[\"id\"]);\n                                if(editedMessageText){\n                                    editedMessageText.innerText = messages[\"edited\"][i][\"text\"];\n                                    let img = document.createElement(\"img\");\n                                    img.setAttribute(\"src\", \"resources\\\\images\\\\hippo.png\");\n                                    img.setAttribute(\"width\", \"40\");\n                                    img.setAttribute(\"height\", \"40\");\n                                    editedMessageText.appendChild(img);\n                                }\n                                message[\"edited\"] = true;\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        if(messages[\"new\"]){\n            for (let i = 0; i < messages[\"new\"].length; i++) {\n                let messageDiv = document.createElement(\"div\");\n                messageDiv.setAttribute(\"id\", \"message\" + messages[\"new\"][i][\"id\"]);\n\n                let paragraphElement = document.createElement(\"p\");\n                if (messages[\"new\"][i][\"sender\"] === username) {\n                    paragraphElement.setAttribute(\"class\", \"message myMessage\");\n                    messageDiv.setAttribute(\"class\", \"messageDiv myMessageDiv\");\n                } else {\n                    messageDiv.setAttribute(\"class\", \"messageDiv\");\n                    paragraphElement.setAttribute(\"class\", \"message\");\n                }\n\n                paragraphElement.setAttribute(\"id\", messages[\"new\"][i][\"id\"]);\n                paragraphElement.innerText = messages[\"new\"][i][\"text\"];\n                messageDiv.appendChild(paragraphElement);\n                let editLink = document.createElement(\"a\");\n                editLink.innerText = \"edit\";\n                editLink.setAttribute(\"id\", \"edit\" + messages[\"new\"][i][\"id\"]);\n                editLink.setAttribute(\"class\", \"editLink\");\n                messageDiv.appendChild(editLink);\n                editLink.onclick = function (e) {\n                    let id = e.path[1].id;\n\n                    id = id.substr(\"message\".length, id.length - 6);\n                    edit(e, user2, id);\n                };\n                let deleteLink = document.createElement(\"a\");\n                deleteLink.innerText = \"delete\";\n                deleteLink.setAttribute(\"id\", \"delete\" + messages[\"new\"][i][\"id\"]);\n                deleteLink.setAttribute(\"class\", \"deleteLink\");\n                messageDiv.appendChild(deleteLink);\n                deleteLink.onclick = function (e) {\n                    let id = e.path[1].id;\n\n                    id = id.substr(\"message\".length, id.length - 6);\n                    deleteMessage(id, user2);\n                };\n                let messageDate = document.createElement(\"a\");\n                messageDate.setAttribute(\"class\", \"messageDate\");\n                let date = new Date(messages[\"new\"][i][\"date\"]);\n                messageDate.innerText = date.getDate() + \"/\" + date.getMonth() + \" \" + date.getHours() + \":\" + date.getMinutes();\n                messageDiv.appendChild(messageDate);\n                box.appendChild(messageDiv);\n            }\n        }\n\n    }\n}\nfunction editMessage(id, text, reciever) {\n\n\n    var xhttp = new XMLHttpRequest();\n    xhttp.onreadystatechange = function () {\n        if (this.readyState == 4 && this.status == 200) {\n            for (let message of chats.get(reciever)) {\n                if (message[\"id\"] === id) {\n                    message[\"text\"] = text;\n                    document.getElementById(id).innerText = text;\n                    return;\n                }\n            }\n        }\n    };\n    xhttp.open(\"put\", \"/messages\", true);\n    let messageInfo = {\n        \"id\": id,\n        \"text\": text,\n        \"reciever\": reciever\n\n    };\n    xhttp.setRequestHeader('Content-type', 'application/json; charset=utf-8');\n    xhttp.send(JSON.stringify(messageInfo));\n\n}\n\nfunction deleteMessage(id, reciever) {\n    var xhttp = new XMLHttpRequest();\n    xhttp.onreadystatechange = function () {\n        if (this.readyState == 4 && this.status == 200) {\n            let deletedMessage = document.getElementById(\"message\"+id);\n            deletedMessage.parentNode.removeChild(deletedMessage);\n        }\n    };\n    xhttp.open(\"delete\", \"/messages\", true);\n    let messageInfo = {\n        \"id\": id,\n        \"reciever\": reciever\n\n    };\n    xhttp.setRequestHeader('Content-type', 'application/json; charset=utf-8');\n    xhttp.send(JSON.stringify(messageInfo));\n\n}\n\nfunction edit(e, user2, messageId) {\n    let messageDiv =  document.getElementById(\"message\" + messageId);\n    let paragraphElement = document.getElementById(messageId);\n\n\n    let text = paragraphElement.textContent;\n\n    let editInput = document.createElement(\"input\");\n    editInput.setAttribute(\"type\", \"text\");\n    editInput.setAttribute(\"id\", \"editInput\" + messageId);\n    editInput.value = text;\n    paragraphElement.innerText = \"\";\n\n    let saveButton = document.createElement(\"input\");\n    saveButton.setAttribute(\"type\", \"button\");\n    saveButton.setAttribute(\"id\", \"save\" + messageId);\n    saveButton.setAttribute(\"value\", \"Save\");\n    paragraphElement.appendChild(editInput);\n    saveButton.onclick = function (e) {\n        let newText = document.getElementById(\"editInput\" + messageId).value;\n        editMessage(messageId, newText, user2);\n        paragraphElement.innerText = newText;\n    };\n    paragraphElement.appendChild(saveButton);\n\n\n}
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
--- target/chat/resources/js/profile.js	(date 1541774767000)
+++ target/chat/resources/js/profile.js	(revision )
@@ -107,8 +107,13 @@
                 document.getElementById("chats").appendChild(div);
 
 
-                if(chats.get(username2))
-                    renderMessages(chats.get(username2),username2);
+                if(chats.get(username2)){
+                    let map ={
+                        "new":chats.get(username2)
+                    };
+                    renderMessages(map,username2);
+                }
+
                 chatopen = true;
             }
         };
@@ -144,7 +149,6 @@
 
     let lastMessageDate = chat && chat.length > 0 ? chat[chat.length - 1]["date"] :  0;
     lastMessageDate = new Date(lastMessageDate);
-    //console.log(typeof lastMessageDate);
     var xhttp = new XMLHttpRequest();
     xhttp.onreadystatechange = function () {
         if (this.readyState == 4 && this.status == 200) {
@@ -200,6 +204,7 @@
             }
         }
         if(messages["new"]){
+            console.log(1);
             for (let i = 0; i < messages["new"].length; i++) {
                 let messageDiv = document.createElement("div");
                 messageDiv.setAttribute("id", "message" + messages["new"][i]["id"]);
@@ -223,7 +228,6 @@
                 messageDiv.appendChild(editLink);
                 editLink.onclick = function (e) {
                     let id = e.path[1].id;
-
                     id = id.substr("message".length, id.length - 6);
                     edit(e, user2, id);
                 };
